<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagn√≥stico de Roles - Chicoj</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    .btn {
      display: inline-block;
      padding: 12px 24px;
      margin: 10px 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #2196F3;
      color: white;
    }
    .btn-primary:hover {
      background: #1976D2;
    }
    .btn-success {
      background: #4CAF50;
      color: white;
    }
    .btn-success:hover {
      background: #45a049;
    }
    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196F3;
      padding: 15px;
      margin: 20px 0;
    }
    .result-box {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      margin: 20px 0;
      font-family: monospace;
      max-height: 400px;
      overflow-y: auto;
    }
    .role-item {
      padding: 10px;
      margin: 5px 0;
      background: white;
      border-left: 4px solid #4CAF50;
      border-radius: 4px;
    }
    .role-item strong {
      color: #2196F3;
    }
    .error {
      background: #ffebee;
      border-left: 4px solid #f44336;
      color: #c62828;
    }
    .success {
      background: #e8f5e9;
      border-left: 4px solid #4CAF50;
      color: #2e7d32;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Diagn√≥stico de Roles - Sistema Chicoj</h1>
    
    <div class="info-box">
      <p><strong>¬øPara qu√© sirve esto?</strong></p>
      <p>Esta herramienta verifica qu√© roles est√°n registrados en el sistema y si se est√°n cargando correctamente.</p>
    </div>

    <button class="btn btn-primary" onclick="cargarRoles()">
      üîÑ Cargar Roles desde API
    </button>

    <button class="btn btn-success" onclick="verEnBaseDeDatos()">
      üìä Ver Instrucciones SQL
    </button>

    <div id="resultado" class="result-box" style="display: none;">
      Cargando...
    </div>

    <div style="margin-top: 30px;">
      <a href="/templates/administracion/agregar_usuarios.html" style="color: #2196F3; text-decoration: none; font-weight: bold;">
        ‚Üê Volver a Agregar Usuario
      </a>
    </div>
  </div>

  <script src="/scripts/config.js"></script>
  <script src="/scripts/api.js"></script>

  <script>
    async function cargarRoles() {
      const resultadoDiv = document.getElementById('resultado');
      resultadoDiv.style.display = 'block';
      resultadoDiv.innerHTML = '<p>‚è≥ Cargando roles desde el servidor...</p>';

      try {
        // Verificar autenticaci√≥n
        const token = AuthManager.getToken();
        if (!token) {
          resultadoDiv.innerHTML = `
            <div class="error">
              <strong>‚ùå Error de Autenticaci√≥n</strong><br>
              No hay token de sesi√≥n. Por favor inicia sesi√≥n primero.
            </div>
          `;
          return;
        }

        console.log('üîë Token encontrado:', token.substring(0, 20) + '...');

        // Cargar roles
        const response = await API.users.getRoles();
        const data = response.data || response;
        const roles = data.roles || data || [];

        console.log('üì¶ Respuesta completa:', response);
        console.log('üé≠ Roles recibidos:', roles);

        if (roles.length === 0) {
          resultadoDiv.innerHTML = `
            <div class="error">
              <strong>‚ö†Ô∏è No se encontraron roles</strong><br>
              La API devolvi√≥ una lista vac√≠a. Verifica que existan roles en la base de datos.
            </div>
          `;
          return;
        }

        // Mostrar roles
        let html = `
          <div class="success">
            <strong>‚úÖ ${roles.length} Roles Encontrados</strong>
          </div>
          <br>
          <strong>Lista de Roles:</strong><br><br>
        `;

        roles.forEach((role, index) => {
          html += `
            <div class="role-item">
              <strong>#${index + 1}</strong> - 
              <strong>ID:</strong> ${role.id_rol} | 
              <strong>Nombre:</strong> ${role.nombre_rol}
              ${role.descripcion ? ` | <em>${role.descripcion}</em>` : ''}
            </div>
          `;
        });

        html += `
          <br>
          <div class="info-box">
            <strong>üí° Si agregaste un rol nuevo y no aparece aqu√≠:</strong><br>
            1. Verifica que se haya guardado correctamente en la base de datos<br>
            2. Revisa la consola del navegador (F12) para ver errores<br>
            3. Haz Ctrl+Shift+R para recargar sin cach√©<br>
            4. Verifica que el backend est√© corriendo
          </div>
        `;

        resultadoDiv.innerHTML = html;

      } catch (error) {
        console.error('‚ùå Error completo:', error);
        
        resultadoDiv.innerHTML = `
          <div class="error">
            <strong>‚ùå Error al cargar roles</strong><br>
            <strong>Mensaje:</strong> ${error.message}<br>
            <strong>Estado HTTP:</strong> ${error.statusCode || 'N/A'}<br><br>
            <strong>Detalles t√©cnicos:</strong><br>
            <pre>${JSON.stringify(error, null, 2)}</pre>
          </div>
          <br>
          <div class="info-box">
            <strong>üîß Posibles soluciones:</strong><br>
            1. Verifica que el backend est√© corriendo en http://localhost:3000<br>
            2. Verifica que hayas iniciado sesi√≥n<br>
            3. Limpia localStorage y vuelve a iniciar sesi√≥n<br>
            4. Revisa la consola del navegador (F12) para m√°s detalles
          </div>
        `;
      }
    }

    function verEnBaseDeDatos() {
      const resultadoDiv = document.getElementById('resultado');
      resultadoDiv.style.display = 'block';
      
      resultadoDiv.innerHTML = `
        <div class="info-box">
          <strong>üìä Verificar Roles en Base de Datos</strong>
        </div>

        <p><strong>Opci√≥n 1: Prisma Studio</strong></p>
        <p>Abre una terminal en la carpeta <code>backend/</code> y ejecuta:</p>
        <pre style="background: #263238; color: #aed581; padding: 15px; border-radius: 4px; overflow-x: auto;">
npx prisma studio
</pre>
        <p>Esto abrir√° una interfaz web donde podr√°s ver y editar la tabla <code>roles</code>.</p>

        <hr style="margin: 30px 0;">

        <p><strong>Opci√≥n 2: SQL Directo (PostgreSQL)</strong></p>
        <p>Con√©ctate a tu base de datos y ejecuta:</p>
        <pre style="background: #263238; color: #aed581; padding: 15px; border-radius: 4px; overflow-x: auto;">
-- Ver todos los roles
SELECT * FROM roles ORDER BY id_rol;

-- Agregar un rol nuevo (ejemplo)
INSERT INTO roles (nombre_rol, descripcion) 
VALUES ('NuevoRol', 'Descripci√≥n del nuevo rol');

-- Ver roles con usuarios asignados
SELECT r.*, COUNT(u.id_usuario) as total_usuarios
FROM roles r
LEFT JOIN usuarios u ON u.id_rol = r.id_rol
GROUP BY r.id_rol
ORDER BY r.nombre_rol;
</pre>

        <hr style="margin: 30px 0;">

        <p><strong>Opci√≥n 3: Verificar desde Node.js</strong></p>
        <p>Crea un archivo <code>backend/test-roles.js</code> con:</p>
        <pre style="background: #263238; color: #aed581; padding: 15px; border-radius: 4px; overflow-x: auto;">
import prisma from './src/config/database.js';

async function testRoles() {
  const roles = await prisma.roles.findMany();
  console.log('üé≠ Roles en la base de datos:');
  console.table(roles);
  await prisma.$disconnect();
}

testRoles();
</pre>
        <p>Ejecuta: <code>node backend/test-roles.js</code></p>

        <hr style="margin: 30px 0;">

        <div class="info-box">
          <strong>‚úÖ Despu√©s de agregar un rol:</strong><br>
          1. Recarga esta p√°gina (F5)<br>
          2. Click en "üîÑ Cargar Roles desde API"<br>
          3. El nuevo rol debe aparecer en la lista
        </div>
      `;
    }

    // Auto-cargar roles al abrir la p√°gina
    window.addEventListener('DOMContentLoaded', () => {
      // Verificar autenticaci√≥n
      if (!AuthManager.isAuthenticated()) {
        const resultadoDiv = document.getElementById('resultado');
        resultadoDiv.style.display = 'block';
        resultadoDiv.innerHTML = `
          <div class="error">
            <strong>‚ùå No has iniciado sesi√≥n</strong><br>
            Por favor inicia sesi√≥n primero para ver los roles.
          </div>
          <br>
          <a href="/templates/login.html" class="btn btn-primary">Ir al Login</a>
        `;
      }
    });
  </script>
</body>
</html>

