<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”” Test de Notificaciones</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 2rem auto;
      padding: 2rem;
      background: #f5f5f5;
    }
    
    .section {
      background: white;
      padding: 2rem;
      margin-bottom: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #2196F3;
      border-bottom: 3px solid #2196F3;
      padding-bottom: 1rem;
    }
    
    h2 {
      color: #666;
      margin-top: 0;
    }
    
    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    button:hover {
      background: #1976D2;
    }
    
    .success {
      background: #4CAF50;
    }
    
    .success:hover {
      background: #45a049;
    }
    
    .danger {
      background: #f44336;
    }
    
    .danger:hover {
      background: #da190b;
    }
    
    .info-box {
      background: #e3f2fd;
      padding: 1rem;
      border-left: 4px solid #2196F3;
      margin: 1rem 0;
    }
    
    .warning-box {
      background: #fff3e0;
      padding: 1rem;
      border-left: 4px solid #FF9800;
      margin: 1rem 0;
    }
    
    .error-box {
      background: #ffebee;
      padding: 1rem;
      border-left: 4px solid #f44336;
      margin: 1rem 0;
    }
    
    #results {
      background: #f9f9f9;
      padding: 1rem;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
    }
    
    .result-item {
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      border-radius: 3px;
    }
    
    .result-success {
      background: #d4edda;
      color: #155724;
    }
    
    .result-error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .result-info {
      background: #d1ecf1;
      color: #0c5460;
    }
  </style>
</head>
<body>
  <h1>ğŸ”” Test de Sistema de Notificaciones</h1>
  
  <div class="section">
    <h2>ğŸ“Š Estado del Sistema</h2>
    <div id="system-status">
      <p>Verificando...</p>
    </div>
  </div>
  
  <div class="section">
    <h2>ğŸ§ª Pruebas</h2>
    
    <div class="info-box">
      <strong>â„¹ï¸ Instrucciones:</strong>
      <ol>
        <li>Primero verifica que estÃ©s logueado como <strong>mesero1</strong></li>
        <li>Haz clic en cada botÃ³n para probar las funcionalidades</li>
        <li>Revisa los resultados en la consola y en el panel de abajo</li>
      </ol>
    </div>
    
    <button onclick="testAuth()">ğŸ”‘ Test AutenticaciÃ³n</button>
    <button onclick="testGetNotifications()">ğŸ“‹ Get Notificaciones</button>
    <button onclick="testGetUnread()" class="success">ğŸ“¬ Get No LeÃ­das</button>
    <button onclick="testGetCount()">ğŸ”¢ Get Contador</button>
    <button onclick="testMarkAsRead()" class="danger">âœ“ Marcar como LeÃ­da</button>
    <button onclick="clearResults()">ğŸ§¹ Limpiar Resultados</button>
  </div>
  
  <div class="section">
    <h2>ğŸ“Š Resultados</h2>
    <div id="results">
      <p class="result-info">Esperando pruebas...</p>
    </div>
  </div>
  
  <!-- Scripts -->
  <script src="/scripts/config.js"></script>
  <script src="/scripts/api.js?v=20251024c"></script>
  
  <script>
    // FunciÃ³n para agregar resultado
    function addResult(message, type = 'info') {
      const results = document.getElementById('results');
      const item = document.createElement('div');
      item.className = `result-item result-${type}`;
      item.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
      results.insertBefore(item, results.firstChild);
    }
    
    // FunciÃ³n para limpiar resultados
    function clearResults() {
      document.getElementById('results').innerHTML = '<p class="result-info">Resultados limpiados.</p>';
    }
    
    // Test de autenticaciÃ³n
    async function testAuth() {
      console.log('ğŸ”‘ Testeando autenticaciÃ³n...');
      addResult('ğŸ”‘ Testeando autenticaciÃ³n...', 'info');
      
      const user = AuthManager.getUser();
      const token = AuthManager.getToken();
      
      if (!user || !token) {
        console.error('âŒ No hay usuario logueado');
        addResult('âŒ No hay usuario logueado. Ve a /templates/login.html', 'error');
        return;
      }
      
      console.log('âœ… Usuario:', user);
      console.log('âœ… Token presente');
      addResult(`âœ… Logueado como: ${user.usuario_nombre} (ID: ${user.id_usuario})`, 'success');
      addResult(`âœ… Token: ${token.substring(0, 20)}...`, 'success');
    }
    
    // Test get notificaciones
    async function testGetNotifications() {
      console.log('ğŸ“‹ Testeando GET /api/notifications...');
      addResult('ğŸ“‹ Testeando GET /api/notifications...', 'info');
      
      try {
        const response = await API.notifications.getAll();
        console.log('âœ… Respuesta:', response);
        addResult(`âœ… Ã‰xito: ${response.data?.notificaciones?.length || 0} notificaciones`, 'success');
        addResult(`Datos: ${JSON.stringify(response.data, null, 2)}`, 'info');
      } catch (error) {
        console.error('âŒ Error:', error);
        addResult(`âŒ Error: ${error.message}`, 'error');
      }
    }
    
    // Test get no leÃ­das
    async function testGetUnread() {
      console.log('ğŸ“¬ Testeando GET /api/notifications/unread...');
      addResult('ğŸ“¬ Testeando GET /api/notifications/unread...', 'info');
      
      try {
        const response = await API.notifications.getUnread();
        console.log('âœ… Respuesta:', response);
        const notifications = response.data?.notificaciones || [];
        addResult(`âœ… Ã‰xito: ${notifications.length} notificaciones no leÃ­das`, 'success');
        
        if (notifications.length > 0) {
          notifications.forEach((notif, index) => {
            addResult(`  ${index + 1}. ${notif.titulo} - ${notif.mensaje}`, 'info');
          });
        } else {
          addResult('  â„¹ï¸ No hay notificaciones no leÃ­das', 'info');
        }
      } catch (error) {
        console.error('âŒ Error:', error);
        addResult(`âŒ Error: ${error.message}`, 'error');
      }
    }
    
    // Test get contador
    async function testGetCount() {
      console.log('ğŸ”¢ Testeando GET /api/notifications/count...');
      addResult('ğŸ”¢ Testeando GET /api/notifications/count...', 'info');
      
      try {
        const response = await API.notifications.getCount();
        console.log('âœ… Respuesta:', response);
        const data = response.data || {};
        addResult(`âœ… Total: ${data.total}, No leÃ­das: ${data.no_leidas}, LeÃ­das: ${data.leidas}`, 'success');
      } catch (error) {
        console.error('âŒ Error:', error);
        addResult(`âŒ Error: ${error.message}`, 'error');
      }
    }
    
    // Test marcar como leÃ­da
    async function testMarkAsRead() {
      console.log('âœ“ Testeando PATCH /api/notifications/:id/read...');
      addResult('âœ“ Obteniendo primera notificaciÃ³n no leÃ­da...', 'info');
      
      try {
        // Primero obtener una notificaciÃ³n no leÃ­da
        const response = await API.notifications.getUnread();
        const notifications = response.data?.notificaciones || [];
        
        if (notifications.length === 0) {
          addResult('âš ï¸ No hay notificaciones no leÃ­das para marcar', 'error');
          return;
        }
        
        const firstNotif = notifications[0];
        addResult(`ğŸ“‹ Marcando notificaciÃ³n ID: ${firstNotif.id_notificacion}`, 'info');
        
        const markResponse = await API.notifications.markAsRead(firstNotif.id_notificacion);
        console.log('âœ… Respuesta:', markResponse);
        addResult(`âœ… NotificaciÃ³n marcada como leÃ­da`, 'success');
        
        // Refrescar contador
        await testGetCount();
      } catch (error) {
        console.error('âŒ Error:', error);
        addResult(`âŒ Error: ${error.message}`, 'error');
      }
    }
    
    // Verificar estado del sistema al cargar
    window.addEventListener('DOMContentLoaded', () => {
      const statusDiv = document.getElementById('system-status');
      
      const user = AuthManager.getUser();
      const token = AuthManager.getToken();
      
      if (!user || !token) {
        statusDiv.innerHTML = `
          <div class="error-box">
            <strong>âŒ No estÃ¡s logueado</strong>
            <p>Por favor inicia sesiÃ³n en <a href="/templates/login.html">/templates/login.html</a></p>
            <p>Usuario recomendado: <strong>mesero1</strong> / ContraseÃ±a: <strong>1234</strong></p>
          </div>
        `;
      } else {
        statusDiv.innerHTML = `
          <div class="info-box">
            <strong>âœ… Sistema OK</strong>
            <p>ğŸ‘¤ Usuario: <strong>${user.usuario_nombre}</strong> (ID: ${user.id_usuario})</p>
            <p>ğŸ”‘ Token: Presente</p>
            <p>ğŸ·ï¸ Rol: <strong>${user.rol}</strong></p>
          </div>
        `;
        
        // Auto-test al cargar
        setTimeout(() => {
          testAuth();
          testGetUnread();
        }, 500);
      }
    });
  </script>
</body>
</html>

