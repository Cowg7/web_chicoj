<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🔔 Test de Notificaciones</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 2rem auto;
      padding: 2rem;
      background: #f5f5f5;
    }
    
    .section {
      background: white;
      padding: 2rem;
      margin-bottom: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #2196F3;
      border-bottom: 3px solid #2196F3;
      padding-bottom: 1rem;
    }
    
    h2 {
      color: #666;
      margin-top: 0;
    }
    
    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    button:hover {
      background: #1976D2;
    }
    
    .success {
      background: #4CAF50;
    }
    
    .success:hover {
      background: #45a049;
    }
    
    .danger {
      background: #f44336;
    }
    
    .danger:hover {
      background: #da190b;
    }
    
    .info-box {
      background: #e3f2fd;
      padding: 1rem;
      border-left: 4px solid #2196F3;
      margin: 1rem 0;
    }
    
    .warning-box {
      background: #fff3e0;
      padding: 1rem;
      border-left: 4px solid #FF9800;
      margin: 1rem 0;
    }
    
    .error-box {
      background: #ffebee;
      padding: 1rem;
      border-left: 4px solid #f44336;
      margin: 1rem 0;
    }
    
    #results {
      background: #f9f9f9;
      padding: 1rem;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
    }
    
    .result-item {
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      border-radius: 3px;
    }
    
    .result-success {
      background: #d4edda;
      color: #155724;
    }
    
    .result-error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .result-info {
      background: #d1ecf1;
      color: #0c5460;
    }
  </style>
</head>
<body>
  <h1>🔔 Test de Sistema de Notificaciones</h1>
  
  <div class="section">
    <h2>📊 Estado del Sistema</h2>
    <div id="system-status">
      <p>Verificando...</p>
    </div>
  </div>
  
  <div class="section">
    <h2>🧪 Pruebas</h2>
    
    <div class="info-box">
      <strong>ℹ️ Instrucciones:</strong>
      <ol>
        <li>Primero verifica que estés logueado como <strong>mesero1</strong></li>
        <li>Haz clic en cada botón para probar las funcionalidades</li>
        <li>Revisa los resultados en la consola y en el panel de abajo</li>
      </ol>
    </div>
    
    <button onclick="testAuth()">🔑 Test Autenticación</button>
    <button onclick="testGetNotifications()">📋 Get Notificaciones</button>
    <button onclick="testGetUnread()" class="success">📬 Get No Leídas</button>
    <button onclick="testGetCount()">🔢 Get Contador</button>
    <button onclick="testMarkAsRead()" class="danger">✓ Marcar como Leída</button>
    <button onclick="clearResults()">🧹 Limpiar Resultados</button>
  </div>
  
  <div class="section">
    <h2>📊 Resultados</h2>
    <div id="results">
      <p class="result-info">Esperando pruebas...</p>
    </div>
  </div>
  
  <!-- Scripts -->
  <script src="/scripts/config.js"></script>
  <script src="/scripts/api.js?v=20251024c"></script>
  
  <script>
    // Función para agregar resultado
    function addResult(message, type = 'info') {
      const results = document.getElementById('results');
      const item = document.createElement('div');
      item.className = `result-item result-${type}`;
      item.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
      results.insertBefore(item, results.firstChild);
    }
    
    // Función para limpiar resultados
    function clearResults() {
      document.getElementById('results').innerHTML = '<p class="result-info">Resultados limpiados.</p>';
    }
    
    // Test de autenticación
    async function testAuth() {
      console.log('🔑 Testeando autenticación...');
      addResult('🔑 Testeando autenticación...', 'info');
      
      const user = AuthManager.getUser();
      const token = AuthManager.getToken();
      
      if (!user || !token) {
        console.error('❌ No hay usuario logueado');
        addResult('❌ No hay usuario logueado. Ve a /templates/login.html', 'error');
        return;
      }
      
      console.log('✅ Usuario:', user);
      console.log('✅ Token presente');
      addResult(`✅ Logueado como: ${user.usuario_nombre} (ID: ${user.id_usuario})`, 'success');
      addResult(`✅ Token: ${token.substring(0, 20)}...`, 'success');
    }
    
    // Test get notificaciones
    async function testGetNotifications() {
      console.log('📋 Testeando GET /api/notifications...');
      addResult('📋 Testeando GET /api/notifications...', 'info');
      
      try {
        const response = await API.notifications.getAll();
        console.log('✅ Respuesta:', response);
        addResult(`✅ Éxito: ${response.data?.notificaciones?.length || 0} notificaciones`, 'success');
        addResult(`Datos: ${JSON.stringify(response.data, null, 2)}`, 'info');
      } catch (error) {
        console.error('❌ Error:', error);
        addResult(`❌ Error: ${error.message}`, 'error');
      }
    }
    
    // Test get no leídas
    async function testGetUnread() {
      console.log('📬 Testeando GET /api/notifications/unread...');
      addResult('📬 Testeando GET /api/notifications/unread...', 'info');
      
      try {
        const response = await API.notifications.getUnread();
        console.log('✅ Respuesta:', response);
        const notifications = response.data?.notificaciones || [];
        addResult(`✅ Éxito: ${notifications.length} notificaciones no leídas`, 'success');
        
        if (notifications.length > 0) {
          notifications.forEach((notif, index) => {
            addResult(`  ${index + 1}. ${notif.titulo} - ${notif.mensaje}`, 'info');
          });
        } else {
          addResult('  ℹ️ No hay notificaciones no leídas', 'info');
        }
      } catch (error) {
        console.error('❌ Error:', error);
        addResult(`❌ Error: ${error.message}`, 'error');
      }
    }
    
    // Test get contador
    async function testGetCount() {
      console.log('🔢 Testeando GET /api/notifications/count...');
      addResult('🔢 Testeando GET /api/notifications/count...', 'info');
      
      try {
        const response = await API.notifications.getCount();
        console.log('✅ Respuesta:', response);
        const data = response.data || {};
        addResult(`✅ Total: ${data.total}, No leídas: ${data.no_leidas}, Leídas: ${data.leidas}`, 'success');
      } catch (error) {
        console.error('❌ Error:', error);
        addResult(`❌ Error: ${error.message}`, 'error');
      }
    }
    
    // Test marcar como leída
    async function testMarkAsRead() {
      console.log('✓ Testeando PATCH /api/notifications/:id/read...');
      addResult('✓ Obteniendo primera notificación no leída...', 'info');
      
      try {
        // Primero obtener una notificación no leída
        const response = await API.notifications.getUnread();
        const notifications = response.data?.notificaciones || [];
        
        if (notifications.length === 0) {
          addResult('⚠️ No hay notificaciones no leídas para marcar', 'error');
          return;
        }
        
        const firstNotif = notifications[0];
        addResult(`📋 Marcando notificación ID: ${firstNotif.id_notificacion}`, 'info');
        
        const markResponse = await API.notifications.markAsRead(firstNotif.id_notificacion);
        console.log('✅ Respuesta:', markResponse);
        addResult(`✅ Notificación marcada como leída`, 'success');
        
        // Refrescar contador
        await testGetCount();
      } catch (error) {
        console.error('❌ Error:', error);
        addResult(`❌ Error: ${error.message}`, 'error');
      }
    }
    
    // Verificar estado del sistema al cargar
    window.addEventListener('DOMContentLoaded', () => {
      const statusDiv = document.getElementById('system-status');
      
      const user = AuthManager.getUser();
      const token = AuthManager.getToken();
      
      if (!user || !token) {
        statusDiv.innerHTML = `
          <div class="error-box">
            <strong>❌ No estás logueado</strong>
            <p>Por favor inicia sesión en <a href="/templates/login.html">/templates/login.html</a></p>
            <p>Usuario recomendado: <strong>mesero1</strong> / Contraseña: <strong>1234</strong></p>
          </div>
        `;
      } else {
        statusDiv.innerHTML = `
          <div class="info-box">
            <strong>✅ Sistema OK</strong>
            <p>👤 Usuario: <strong>${user.usuario_nombre}</strong> (ID: ${user.id_usuario})</p>
            <p>🔑 Token: Presente</p>
            <p>🏷️ Rol: <strong>${user.rol}</strong></p>
          </div>
        `;
        
        // Auto-test al cargar
        setTimeout(() => {
          testAuth();
          testGetUnread();
        }, 500);
      }
    });
  </script>
</body>
</html>

